#!/bin/bash

# Purpose: Returns the input/output buffer size for method 7 (prepare encode frame)
# You need to have the 'companion' file in the same dir as the script
# the companion is generated by joker (only atm) and should be renamed to 'kext_companion'
# I know almost nothing in Radare so I did it manually, if you know better, please update this

if [ $# -eq 0 ]
	then
    echo "Usage: input_output_buffer_size.sh [kext_file] [companion_file]"
    echo "* companion file needs to have the address of the methods table"
    exit 0
fi

echo "[INFO]: Reading companion file.."

methods_table_address=''
for line in `cat $2`
do

	IFS=':' read -r -a array <<< "$line"

    address="${array[0]}"
    name="${array[1]}"

    if [ "$name" == "user_client_1_methods" ]; then
    	methods_table_address=$address
    fi
done

r2=$(r2 -qc "$methods_table_address; pd 48" -e 'scr.color=false' "$1");
r2=$(echo $r2 | sed 's/invalid//g');

input=$(
python -c "
r2='$r2'.split('  ');
r2=[' '.join(r2[i:i+6]).strip() for i in range(0, len(r2), 6)];
method_7=r2[7].split(' ')
print '#define ENCODE_FRAME_INPUT_BUFFER_SIZE ({0})\\n'.format(hex(int(method_7[5] + method_7[7], 16)))
")

output=$(
python -c "
r2='$r2'.split('  ');
r2=[' '.join(r2[i:i+6]).strip() for i in range(0, len(r2), 6)];
method_7=r2[7].split(' ')
print '#define ENCODE_FRAME_OUTPUT_BUFFER_SIZE ({0})'.format(hex(int(method_7[9] + method_7[11], 16)))
")
echo -e $input
echo -e $output
